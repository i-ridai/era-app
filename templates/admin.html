<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Era 管理者ダッシュボード</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Frappe Gantt -->
  <link rel="stylesheet" href="https://unpkg.com/frappe-gantt/dist/frappe-gantt.css" />
  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet" />
  <style>
    :root { --bs-primary:#00BFFF !important; }
    body { background:#fff; }
    .badge-tag { background:#e8f7ff; border:1px solid #bfe9ff; color:#086ea1; }
    .view-switch .nav-link { min-width: 140px; }
    .kanban-wrap { gap: 2%; }
    .kanban-column {
      width: 32%;
      background: #f0faff;
      padding: 12px;
      border-radius: 12px;
      min-height: 80px;
      border: 1px dashed #bfe9ff;
    }
    .kanban-card {
      background: #fff;
      border-left: 6px solid #00BFFF;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
      padding: 12px;
      margin-bottom: 12px;
      cursor: grab;
    }
    .progress-track {
      position: relative;
      height: 10px;
      background: #eef7ff;
      border-radius: 6px;
      margin-top: 8px;
      cursor: pointer;
      user-select: none;
    }
    .progress-fill {
      height: 10px;
      background: #00BFFF;
      border-radius: 6px;
      width: 0%;
    }
    .progress-label { font-size: 12px; color:#0d6efd; }
    #gantt { overflow-x:auto; }
    .fc .fc-button-primary { background:#00BFFF;border-color:#00BFFF; }
    .fc .fc-daygrid-day-number { text-decoration: none; }
    .table thead th { white-space: nowrap; }
  </style>
</head>
<body>
<div class="container py-4">

  <h1 class="mb-4">Era 管理者ダッシュボード</h1>

  <!-- 1. ダッシュボード（メトリクス） -->
  <section id="section-dashboard" class="mb-4">
    <div class="row g-3">
      <div class="col-md-3">
        <div class="card shadow-sm"><div class="card-body">
          <div class="text-muted small">タスク総数</div>
          <div id="metric-total" class="fs-3 fw-bold">0</div>
        </div></div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm"><div class="card-body">
          <div class="text-muted small">進行中</div>
          <div id="metric-doing" class="fs-3 fw-bold">0</div>
        </div></div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm"><div class="card-body">
          <div class="text-muted small">完了</div>
          <div id="metric-done" class="fs-3 fw-bold">0</div>
        </div></div>
      </div>
    </div>
  </section>

  <!-- 1-1. タスク作成 -->
  <section id="section-create" class="mb-5">
    <h4 class="mb-3">1-1. タスク作成</h4>
    <form id="taskForm" class="row g-3">
      <input type="hidden" id="editId" />
      <div class="col-md-4">
        <label class="form-label">タスク名</label>
        <input type="text" id="taskName" class="form-control" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">担当者</label>
        <input type="text" id="taskAssignee" class="form-control" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">工事内容</label>
        <input type="text" id="taskWorkType" class="form-control" placeholder="例：配管, 電気, 基礎" />
      </div>
      <div class="col-md-2">
        <label class="form-label">ステータス</label>
        <select id="taskStatus" class="form-select">
          <option value="ToDo">ToDo</option>
          <option value="進行中">進行中</option>
          <option value="完了">完了</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">開始日</label>
        <input type="date" id="taskStart" class="form-control" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">期限</label>
        <input type="date" id="taskEnd" class="form-control" required />
      </div>
      <div class="col-md-2">
        <label class="form-label">進捗 (%)</label>
        <input type="number" id="taskProgress" min="0" max="100" value="0" class="form-control" />
      </div>
      <div class="col-md-4">
        <label class="form-label">タグ（カンマ区切り）</label>
        <input type="text" id="taskTags" class="form-control" placeholder="高優先, 設備" />
      </div>
      <div class="col-12">
        <label class="form-label">備考</label>
        <textarea id="taskNotes" class="form-control" rows="2" placeholder="補足や注意点など"></textarea>
      </div>
      <div class="col-12">
        <button type="submit" class="btn btn-primary">保存</button>
        <button type="button" class="btn btn-outline-secondary" id="btnReset">クリア</button>
      </div>
    </form>
  </section>

  <!-- 1-2. タスク一覧（タブ） -->
  <section id="section-list">
    <div class="d-flex align-items-end justify-content-between mb-3">
      <h4 class="mb-0">1-2. タスク一覧</h4>
      <!-- フィルター -->
      <div class="row g-2">
        <div class="col">
          <select id="filterAssignee" class="form-select">
            <option value="">担当者：全て</option>
          </select>
        </div>
        <div class="col">
          <select id="filterWorkType" class="form-select">
            <option value="">工事内容：全て</option>
          </select>
        </div>
        <div class="col">
          <input type="date" id="filterFrom" class="form-control" placeholder="開始(From)">
        </div>
        <div class="col">
          <input type="date" id="filterTo" class="form-control" placeholder="終了(To)">
        </div>
        <div class="col-auto">
          <button class="btn btn-outline-primary" id="btnApplyFilter">適用</button>
        </div>
        <div class="col-auto">
          <button class="btn btn-outline-secondary" id="btnResetFilter">リセット</button>
        </div>
      </div>
    </div>

    <ul class="nav nav-tabs view-switch" id="viewTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-kanban" type="button" role="tab">1-2-1. カンバン表示</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-timeline" type="button" role="tab">1-2-2. タイムライン表示</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-calendar" type="button" role="tab">1-2-3. カレンダー表示</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-table" type="button" role="tab">1-2-4. テーブル表示</button>
      </li>
    </ul>

    <div class="tab-content mt-3">
      <!-- Kanban -->
      <div class="tab-pane fade show active" id="tab-kanban" role="tabpanel">
        <div class="d-flex kanban-wrap">
          <div class="kanban-column" data-status="ToDo" ondragover="allowDrop(event)" ondrop="onDrop(event)">
            <h6 class="mb-3">ToDo</h6>
            <div id="kanban-todo"></div>
          </div>
          <div class="kanban-column" data-status="進行中" ondragover="allowDrop(event)" ondrop="onDrop(event)">
            <h6 class="mb-3">進行中</h6>
            <div id="kanban-doing"></div>
          </div>
          <div class="kanban-column" data-status="完了" ondragover="allowDrop(event)" ondrop="onDrop(event)">
            <h6 class="mb-3">完了</h6>
            <div id="kanban-done"></div>
          </div>
        </div>
      </div>

      <!-- Timeline -->
      <div class="tab-pane fade" id="tab-timeline" role="tabpanel">
        <div id="gantt"></div>
      </div>

      <!-- Calendar -->
      <div class="tab-pane fade" id="tab-calendar" role="tabpanel">
        <div id="calendar"></div>
      </div>

      <!-- Table -->
      <div class="tab-pane fade" id="tab-table" role="tabpanel">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>タスク名</th><th>担当</th><th>工事内容</th><th>開始</th><th>期限</th><th>進捗</th><th>ステータス</th><th>タグ</th><th>操作</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <div class="mt-4">
    <a href="/admin" class="btn btn-link">← ホームに戻る</a>
  </div>

</div>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/frappe-gantt/dist/frappe-gantt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<script>
  // ===== ローカルストレージ =====
  const LS_KEY = "era_tasks_v1";
  function saveToLS() { localStorage.setItem(LS_KEY, JSON.stringify(tasks)); }
  function loadFromLS() {
    try { const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : null; }
    catch(e){ return null; }
  }

  // ===== 初期データ =====
  let tasks = loadFromLS() || [
    { id: 1, name: "基礎工事", assignee: "佐藤", workType:"基礎", start: "2025-08-01", end: "2025-08-10", progress: 40, status: "ToDo", tags: ["工程A","重要"], notes: "地盤調査完了後に開始" },
    { id: 2, name: "足場組立", assignee: "田中", workType:"外構", start: "2025-08-05", end: "2025-08-15", progress: 60, status: "進行中", tags: ["安全","外構"], notes: "足場資材の在庫確認済み" },
    { id: 3, name: "配管工事", assignee: "佐藤", workType:"配管", start: "2025-08-10", end: "2025-08-20", progress: 20, status: "完了", tags: ["水道","住宅"], notes: "施工図面を確認" }
  ];

  // ===== フィルタ状態 =====
  const filter = { assignee:"", workType:"", from:"", to:"" };

  // ===== ユーティリティ =====
  function toISO(d) { return new Date(d).toISOString().slice(0,10); }
  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
  function uniqueValues(key) { return Array.from(new Set(tasks.map(t => (t[key]||"").trim()).filter(Boolean))); }

  function updateMetrics(list) {
    document.getElementById("metric-total").textContent = list.length;
    document.getElementById("metric-doing").textContent = list.filter(t=>t.status==="進行中").length;
    document.getElementById("metric-done").textContent  = list.filter(t=>t.status==="完了").length;
  }

  function applyFilter(list) {
    const f = filter;
    return list.filter(t => {
      if (f.assignee && t.assignee !== f.assignee) return false;
      if (f.workType && t.workType !== f.workType) return false;
      if (f.from && new Date(t.start) < new Date(f.from)) return false;
      if (f.to && new Date(t.end) > new Date(f.to)) return false;
      return true;
    });
  }

  // ===== フィルターUI =====
  function renderFilterOptions() {
    const sa = document.getElementById("filterAssignee");
    const sw = document.getElementById("filterWorkType");
    const assignees = uniqueValues("assignee");
    const works = uniqueValues("workType");
    const saVal = filter.assignee, swVal = filter.workType;
    sa.innerHTML = '<option value="">担当者：全て</option>' + assignees.map(v=>`<option ${v===saVal?'selected':''} value="${v}">${v}</option>`).join("");
    sw.innerHTML = '<option value="">工事内容：全て</option>' + works.map(v=>`<option ${v===swVal?'selected':''} value="${v}">${v}</option>`).join("");
  }
  document.getElementById("btnApplyFilter").addEventListener("click", ()=>{
    filter.assignee = document.getElementById("filterAssignee").value;
    filter.workType = document.getElementById("filterWorkType").value;
    filter.from = document.getElementById("filterFrom").value;
    filter.to   = document.getElementById("filterTo").value;
    renderAll();
  });
  document.getElementById("btnResetFilter").addEventListener("click", ()=>{
    filter.assignee=""; filter.workType=""; filter.from=""; filter.to="";
    document.getElementById("filterAssignee").value="";
    document.getElementById("filterWorkType").value="";
    document.getElementById("filterFrom").value="";
    document.getElementById("filterTo").value="";
    renderAll();
  });

  // ===== レンダリング総括 =====
  function renderAll() {
    const filtered = applyFilter(tasks);
    updateMetrics(filtered);
    renderFilterOptions();
    renderKanban(filtered);
    renderGantt(filtered);
    renderCalendar(filtered);
    renderTable(filtered);
    saveToLS();
  }

  // ===== Kanban（列DnD＋進捗ドラッグ） =====
  function renderKanban(list) {
    const cols = {
      "ToDo": document.getElementById("kanban-todo"),
      "進行中": document.getElementById("kanban-doing"),
      "完了": document.getElementById("kanban-done")
    };
    Object.values(cols).forEach(el => el.innerHTML = "");
    list.forEach(t => {
      const card = document.createElement("div");
      card.className = "kanban-card";
      card.setAttribute("draggable","true");
      card.addEventListener("dragstart", (e)=>onDragStart(e, t.id));

      const tagHtml = (t.tags||[]).map(tag=>`<span class="badge rounded-pill badge-tag me-1">${tag}</span>`).join("");

      card.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <div style="min-width:0;">
            <div class="fw-bold text-truncate" title="${t.name}">${t.name}</div>
            <div class="small text-muted">${t.assignee}｜${t.workType||"-"}｜${t.start} → ${t.end}</div>
            <div class="mt-1">${tagHtml}</div>
            <div class="progress-label mt-1">${t.progress}%</div>
            <div class="progress-track" data-id="${t.id}">
              <div class="progress-fill" style="width:${t.progress}%"></div>
            </div>
          </div>
          <div class="ms-2 flex-shrink-0">
            <button class="btn btn-sm btn-outline-primary mb-1" onclick="event.stopPropagation(); editTask(${t.id});">編集</button>
            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteTask(${t.id});">削除</button>
          </div>
        </div>
      `;
      // 進捗ドラッグ
      const track = card.querySelector(".progress-track");
      let dragging = false;
      const updateFromEvent = (ev)=>{
        const rect = track.getBoundingClientRect();
        const ratio = Math.max(0, Math.min(1, (ev.clientX - rect.left)/rect.width));
        const pct = Math.round(ratio*100);
        const idx = tasks.findIndex(x=>x.id===t.id);
        if (idx>=0){ tasks[idx].progress = pct; }
        track.querySelector(".progress-fill").style.width = pct+"%";
        track.previousElementSibling.textContent = pct+"%";
      };
      track.addEventListener("mousedown",(e)=>{ dragging=true; updateFromEvent(e); });
      window.addEventListener("mousemove",(e)=>{ if(dragging){ updateFromEvent(e); }});
      window.addEventListener("mouseup",()=>{ if(dragging){ dragging=false; saveToLS(); renderGantt(applyFilter(tasks)); }});

      cols[t.status]?.appendChild(card);
    });
  }
  function onDragStart(ev, id){ ev.dataTransfer.setData("text/plain", String(id)); }
  function allowDrop(ev){ ev.preventDefault(); }
  function onDrop(ev){
    ev.preventDefault();
    const id = parseInt(ev.dataTransfer.getData("text/plain"),10);
    const status = ev.currentTarget.getAttribute("data-status");
    const idx = tasks.findIndex(t=>t.id===id);
    if (idx>=0){ tasks[idx].status = status; saveToLS(); renderAll(); }
  }

  // ===== Timeline（Frappe Gantt：日付＆進捗ドラッグ） =====
  let ganttInstance = null;
  function renderGantt(list) {
    const data = list.map(t=>({
      id: t.id,
      name: t.name,
      start: t.start,
      end: t.end,
      progress: t.progress,
      custom_class: "bar"
    }));
    const target = document.getElementById("gantt");
    target.innerHTML = "";
    ganttInstance = new Gantt("#gantt", data, {
      on_click: (task) => editTask(task.id),
      on_date_change: (task, start, end) => {
        const idx = tasks.findIndex(x=>x.id===task.id);
        if (idx>=0){
          tasks[idx].start = toISO(start);
          tasks[idx].end = toISO(end);
          saveToLS();
          renderAll();
        }
      },
      on_progress_change: (task, progress) => {
        const idx = tasks.findIndex(x=>x.id===task.id);
        if (idx>=0){
          tasks[idx].progress = Math.round(progress);
          saveToLS();
          renderKanban(applyFilter(tasks));
        }
      }
    });
  }

  // ===== Calendar（ドラッグ＆リサイズ） =====
  let calendar;
  function renderCalendar(list) {
    const calEl = document.getElementById("calendar");
    if (calendar) { calendar.destroy(); }
    const events = list.map(t=>({
      id: String(t.id),
      title: t.name,
      start: t.start,
      end: addOneDay(t.end), // 非包含
      editable: true
    }));
    calendar = new FullCalendar.Calendar(calEl, {
      initialView: "dayGridMonth",
      events,
      editable: true,
      eventDrop: (info) => {
        const id = parseInt(info.event.id,10);
        const idx = tasks.findIndex(t=>t.id===id);
        if (idx>=0){
          const start = toISO(info.event.start);
          const endISO = toISO(info.event.end ?? info.event.start);
          const realEnd = toISO(new Date(new Date(endISO).getTime() - 24*60*60*1000));
          tasks[idx].start = start;
          tasks[idx].end = realEnd;
          saveToLS(); renderAll();
        }
      },
      eventResize: (info) => {
        const id = parseInt(info.event.id,10);
        const idx = tasks.findIndex(t=>t.id===id);
        if (idx>=0){
          const endISO = toISO(info.event.end);
          const realEnd = toISO(new Date(new Date(endISO).getTime() - 24*60*60*1000));
          tasks[idx].end = realEnd;
          saveToLS(); renderAll();
        }
      },
      eventClick: (info) => { editTask(parseInt(info.event.id,10)); }
    });
    calendar.render();
  }
  function addOneDay(iso){
    const d = new Date(iso); d.setDate(d.getDate()+1); return toISO(d);
  }

  // ===== Table =====
  function renderTable(list) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    list.forEach(t=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><a href="#" onclick="editTask(${t.id});return false;">${t.name}</a></td>
        <td>${t.assignee}</td>
        <td>${t.workType||"-"}</td>
        <td>${t.start}</td>
        <td>${t.end}</td>
        <td>${t.progress}%</td>
        <td>${t.status}</td>
        <td>${(t.tags||[]).map(tag=>`<span class="badge rounded-pill badge-tag me-1">${tag}</span>`).join("")}</td>
        <td class="text-nowrap">
          <button class="btn btn-sm btn-outline-primary me-1" onclick="editTask(${t.id})">編集</button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${t.id})">削除</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ===== 作成/編集/削除 =====
  document.getElementById("taskForm").addEventListener("submit",(e)=>{
    e.preventDefault();
    const idStr = document.getElementById("editId").value;
    const task = {
      id: idStr ? parseInt(idStr,10) : Date.now(),
      name: document.getElementById("taskName").value.trim(),
      assignee: document.getElementById("taskAssignee").value.trim(),
      workType: document.getElementById("taskWorkType").value.trim(),
      status: document.getElementById("taskStatus").value,
      start: document.getElementById("taskStart").value,
      end: document.getElementById("taskEnd").value,
      progress: clamp(parseInt(document.getElementById("taskProgress").value||"0",10),0,100),
      tags: document.getElementById("taskTags").value.split(",").map(s=>s.trim()).filter(Boolean),
      notes: document.getElementById("taskNotes").value.trim()
    };
    if (idStr) {
      const idx = tasks.findIndex(t=>t.id===task.id);
      if (idx>=0) tasks[idx]=task;
    } else {
      tasks.push(task);
    }
    saveToLS();
    clearForm();
    renderAll();
  });

  function editTask(id){
    const t = tasks.find(x=>x.id===id);
    if (!t) return;
    document.getElementById("editId").value = t.id;
    document.getElementById("taskName").value = t.name;
    document.getElementById("taskAssignee").value = t.assignee;
    document.getElementById("taskWorkType").value = t.workType||"";
    document.getElementById("taskStatus").value = t.status;
    document.getElementById("taskStart").value = t.start;
    document.getElementById("taskEnd").value = t.end;
    document.getElementById("taskProgress").value = t.progress;
    document.getElementById("taskTags").value = (t.tags||[]).join(", ");
    document.getElementById("taskNotes").value = t.notes||"";
    window.scrollTo({ top: document.getElementById("section-create").offsetTop - 8, behavior:"smooth" });
  }

  function deleteTask(id){
    if (!confirm("このタスクを削除しますか？")) return;
    tasks = tasks.filter(t=>t.id!==id);
    saveToLS();
    renderAll();
  }

  document.getElementById("btnReset").addEventListener("click", clearForm);
  function clearForm(){
    document.getElementById("taskForm").reset();
    document.getElementById("editId").value = "";
    document.getElementById("taskProgress").value = 0;
  }

  // ===== 初期化 =====
  renderAll();
</script>
</body>
</html>
