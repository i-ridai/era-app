<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Era - タスク生成</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root{ --bs-primary:#00BFFF; }
    body{ background:#fff; padding-top:70px; }
    .nav-link.active, .btn-primary{ background:#00BFFF; border-color:#00BFFF; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom fixed-top">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/admin">Era 管理</a>
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="/admin">ダッシュボード</a></li>
        <li class="nav-item"><a class="nav-link active" href="/admin/task-create">タスク生成</a></li>
        <li class="nav-item"><a class="nav-link" href="/admin/task-view">タスク一覧</a></li>
      </ul>
    </div>
  </nav>

  <main class="container py-4">
    <h1 class="h4 mb-3">タスク生成</h1>
    <form id="taskForm" class="row g-3">
      <div class="col-md-6">
        <label class="form-label">タスク名称</label>
        <input class="form-control" id="title" required />
      </div>

      <div class="col-md-3">
        <label class="form-label">タスク種類</label>
        <select class="form-select" id="type">
          <option>木工事</option><option>配管</option><option>電気</option><option>内装</option><option>外構</option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">担当者</label>
        <select class="form-select" id="assignee">
          <option>菊池</option><option>佐藤</option><option>田中</option><option>鈴木</option><option>高橋</option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">開始予定日</label>
        <input type="date" class="form-control" id="startPlanned" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">開始実績日</label>
        <input type="date" class="form-control" id="startActual" />
      </div>
      <div class="col-md-3">
        <label class="form-label">完了予定日</label>
        <input type="date" class="form-control" id="endPlanned" required />
      </div>
      <div class="col-md-3">
        <label class="form-label">完了実績日</label>
        <input type="date" class="form-control" id="endActual" />
      </div>

      <div class="col-md-3">
        <label class="form-label">ステータス</label>
        <select class="form-select" id="status">
          <option>未着手</option><option>進行中</option><option>完了</option>
        </select>
      </div>

      <div class="col-12">
        <label class="form-label">備考</label>
        <textarea class="form-control" id="remarks" rows="3" placeholder="キッチンカウンターの下地造作をお願いします。"></textarea>
      </div>

      <div class="col-12">
        <button class="btn btn-primary" type="submit">保存して一覧へ</button>
        <a class="btn btn-outline-secondary" href="/admin/task-view">キャンセル</a>
      </div>
    </form>
  </main>

  <script>
  const LS_KEY = "era_tasks_v1";
  function normalize(list){
    return (list||[]).map((t,i)=>{
      const id = t.id ?? Date.now()+i;
      const title = t.title ?? t.name ?? "";
      return {
        id,
        title,
        type: t.type ?? t.workType ?? "",
        assignee: t.assignee ?? "",
        startPlanned: t.startPlanned ?? t.start ?? "",
        startActual: t.startActual ?? "",
        endPlanned: t.endPlanned ?? t.end ?? "",
        endActual: t.endActual ?? "",
        status: t.status ?? "未着手",
        remarks: t.remarks ?? t.notes ?? "",
        progress: typeof t.progress==="number" ? t.progress : 0,
        tags: t.tags || []
      };
    });
  }
  function loadTasks(){ try{ const raw=localStorage.getItem(LS_KEY); return raw? normalize(JSON.parse(raw)) : []; }catch(e){ return []; } }
  function saveTasks(list){ localStorage.setItem(LS_KEY, JSON.stringify(list)); }

  document.getElementById("taskForm").addEventListener("submit", (e)=>{
    e.preventDefault();
    const tasks = loadTasks();
    const data = {
      id: Date.now(),
      title: document.getElementById("title").value.trim(),
      type: document.getElementById("type").value,
      assignee: document.getElementById("assignee").value,
      startPlanned: document.getElementById("startPlanned").value,
      startActual: document.getElementById("startActual").value,
      endPlanned: document.getElementById("endPlanned").value,
      endActual: document.getElementById("endActual").value,
      status: document.getElementById("status").value,
      remarks: document.getElementById("remarks").value.trim(),
      progress: 0,
      tags: []
    };
    tasks.push(data);
    saveTasks(tasks);
    location.href="/admin/task-view";
  });
  </script>
</body>
</html>
