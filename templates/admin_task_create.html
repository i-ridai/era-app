<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Era 管理者 - タスク生成</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root { --bs-primary:#00BFFF !important; }
    body { background:#fff; }
    .navbar-brand span{ width:.65rem;height:.65rem;border-radius:50%;display:inline-block;background:#00BFFF;margin-right:.5rem;vertical-align:middle;}
    .badge-tag { background:#e8f7ff; border:1px solid #bfe9ff; color:#086ea1; }
    .table thead th { white-space: nowrap; }
  </style>
  
</head>
<body>
<nav class="navbar navbar-expand-lg border-bottom mb-3">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/admin"><span></span>Era 管理</a>
    <div class="ms-auto d-flex gap-2">
      <a class="btn btn-outline-primary" href="/admin/task-create">タスク生成</a>
      <a class="btn btn-primary" href="/admin/task-view">タスク一覧</a>
    </div>
  </div>
</nav>
<div class="container pb-5">
<h1 class="mb-4">タスク生成</h1>
<form id="taskForm" class="row g-3">
  <div class="col-md-4"><label class="form-label">タスク名</label><input type="text" id="taskName" class="form-control" required /></div>
  <div class="col-md-3"><label class="form-label">担当者</label><input type="text" id="taskAssignee" class="form-control" required /></div>
  <div class="col-md-3"><label class="form-label">工事内容</label><input type="text" id="taskWorkType" class="form-control" placeholder="例：配管, 電気, 基礎" /></div>
  <div class="col-md-2"><label class="form-label">ステータス</label>
    <select id="taskStatus" class="form-select">
      <option value="ToDo">ToDo</option><option value="進行中">進行中</option><option value="完了">完了</option>
    </select>
  </div>
  <div class="col-md-3"><label class="form-label">開始日</label><input type="date" id="taskStart" class="form-control" required /></div>
  <div class="col-md-3"><label class="form-label">期限</label><input type="date" id="taskEnd" class="form-control" required /></div>
  <div class="col-md-2"><label class="form-label">進捗 (%)</label><input type="number" id="taskProgress" min="0" max="100" value="0" class="form-control" /></div>
  <div class="col-md-4"><label class="form-label">タグ（カンマ区切り）</label><input type="text" id="taskTags" class="form-control" placeholder="高優先, 設備" /></div>
  <div class="col-12"><label class="form-label">備考</label><textarea id="taskNotes" class="form-control" rows="2" placeholder="補足や注意点など"></textarea></div>
  <div class="col-12">
    <button type="submit" class="btn btn-primary">保存</button>
    <a class="btn btn-outline-secondary" href="/admin/task-view">一覧へ</a>
  </div>
</form>

<script>
const LS_KEY = "era_tasks_v1";
function load(){ try{const r=localStorage.getItem(LS_KEY);return r?JSON.parse(r):[];}catch(e){return [];} }
function save(data){ localStorage.setItem(LS_KEY, JSON.stringify(data)); }

// 編集モード対応（一覧から sessionStorage で受け取り）
(function(){
  const raw = sessionStorage.getItem("era_edit_task");
  if(!raw) return;
  const t = JSON.parse(raw);
  document.getElementById("taskName").value=t.name||"";
  document.getElementById("taskAssignee").value=t.assignee||"";
  document.getElementById("taskWorkType").value=t.workType||"";
  document.getElementById("taskStatus").value=t.status||"ToDo";
  document.getElementById("taskStart").value=t.start||"";
  document.getElementById("taskEnd").value=t.end||"";
  document.getElementById("taskProgress").value=t.progress||0;
  document.getElementById("taskTags").value=(t.tags||[]).join(", ");
  document.getElementById("taskNotes").value=t.notes||"";
  document.getElementById("taskForm").dataset.editId = t.id;
})();

document.getElementById("taskForm").addEventListener("submit",(e)=>{
  e.preventDefault();
  const tasks = load();
  const editId = document.getElementById("taskForm").dataset.editId;
  const payload = {
    id: editId ? parseInt(editId,10) : Date.now(),
    name: document.getElementById("taskName").value.trim(),
    assignee: document.getElementById("taskAssignee").value.trim(),
    workType: document.getElementById("taskWorkType").value.trim(),
    status: document.getElementById("taskStatus").value,
    start: document.getElementById("taskStart").value,
    end: document.getElementById("taskEnd").value,
    progress: parseInt(document.getElementById("taskProgress").value||"0",10),
    tags: document.getElementById("taskTags").value.split(",").map(s=>s.trim()).filter(Boolean),
    notes: document.getElementById("taskNotes").value.trim()
  };
  if (editId){
    const idx = tasks.findIndex(x=>x.id===payload.id);
    if (idx>=0) tasks[idx]=payload; else tasks.push(payload);
  }else{
    tasks.push(payload);
  }
  save(tasks);
  sessionStorage.removeItem("era_edit_task");
  alert("保存しました");
  window.location.href = "/admin/task-view";
});
</script>

</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body></html>