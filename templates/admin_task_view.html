<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Era 管理者 - タスク一覧</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root { --bs-primary:#00BFFF !important; }
    body { background:#fff; }
    .navbar-brand span{ width:.65rem;height:.65rem;border-radius:50%;display:inline-block;background:#00BFFF;margin-right:.5rem;vertical-align:middle;}
    .badge-tag { background:#e8f7ff; border:1px solid #bfe9ff; color:#086ea1; }
    .table thead th { white-space: nowrap; }
  </style>
  
<link rel="stylesheet" href="https://unpkg.com/frappe-gantt/dist/frappe-gantt.css" />
<link href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/main.min.css" rel="stylesheet" />
<style>
  .view-switch .nav-link { min-width: 140px; }
  .kanban-wrap { gap: 2%; }
  .kanban-column { width: 32%; background:#f0faff; padding:12px; border-radius:12px; min-height:80px; border:1px dashed #bfe9ff; }
  .kanban-card { background:#fff; border-left:6px solid #00BFFF; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.06); padding:12px; margin-bottom:12px; cursor:pointer; }
  .progress-track { position:relative;height:10px;background:#eef7ff;border-radius:6px;margin-top:8px;cursor:pointer;user-select:none; }
  .progress-fill { height:10px;background:#00BFFF;border-radius:6px;width:0%; }
  .progress-label{ font-size:12px;color:#0d6efd;}
  #gantt { overflow-x:auto; }
  .fc .fc-button-primary { background:#00BFFF;border-color:#00BFFF; }
</style>

</head>
<body>
<nav class="navbar navbar-expand-lg border-bottom mb-3">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/admin"><span></span>Era 管理</a>
    <div class="ms-auto d-flex gap-2">
      <a class="btn btn-outline-primary" href="/admin/task-create">タスク生成</a>
      <a class="btn btn-primary" href="/admin/task-view">タスク一覧</a>
    </div>
  </div>
</nav>
<div class="container pb-5">
<h1 class="mb-3">タスク一覧</h1>
<div class="d-flex align-items-end justify-content-between mb-3">
  <div class="row g-2">
    <div class="col"><select id="filterAssignee" class="form-select"><option value="">担当者：全て</option></select></div>
    <div class="col"><select id="filterWorkType" class="form-select"><option value="">工事内容：全て</option></select></div>
    <div class="col"><input type="date" id="filterFrom" class="form-control"></div>
    <div class="col"><input type="date" id="filterTo" class="form-control"></div>
    <div class="col-auto"><button class="btn btn-outline-primary" id="btnApplyFilter">適用</button></div>
    <div class="col-auto"><button class="btn btn-outline-secondary" id="btnResetFilter">リセット</button></div>
  </div>
  <div><a class="btn btn-outline-primary" href="/admin/task-create">＋ タスク生成</a></div>
</div>

<ul class="nav nav-tabs view-switch" id="viewTabs" role="tablist">
  <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-kanban" type="button">カンバン</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-timeline" type="button">タイムライン</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-calendar" type="button">カレンダー</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-table" type="button">テーブル</button></li>
</ul>

<div class="tab-content mt-3">
  <div class="tab-pane fade show active" id="tab-kanban">
    <div class="d-flex kanban-wrap">
      <div class="kanban-column" data-status="ToDo" ondragover="allowDrop(event)" ondrop="onDrop(event)">
        <h6 class="mb-3">ToDo</h6><div id="kanban-todo"></div>
      </div>
      <div class="kanban-column" data-status="進行中" ondragover="allowDrop(event)" ondrop="onDrop(event)">
        <h6 class="mb-3">進行中</h6><div id="kanban-doing"></div>
      </div>
      <div class="kanban-column" data-status="完了" ondragover="allowDrop(event)" ondrop="onDrop(event)">
        <h6 class="mb-3">完了</h6><div id="kanban-done"></div>
      </div>
    </div>
  </div>
  <div class="tab-pane fade" id="tab-timeline"><div id="gantt"></div></div>
  <div class="tab-pane fade" id="tab-calendar"><div id="calendar"></div></div>
  <div class="tab-pane fade" id="tab-table">
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr><th>タスク名</th><th>担当</th><th>工事内容</th><th>開始</th><th>期限</th><th>進捗</th><th>ステータス</th><th>タグ</th><th>操作</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title" id="taskModalTitle">タスク詳細</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body"><div id="taskModalBody"></div></div>
    <div class="modal-footer"><button class="btn btn-outline-danger" id="btnModalDelete">削除</button>
      <button class="btn btn-primary" id="btnModalEdit">編集</button></div>
  </div></div>
</div>

<script src="https://unpkg.com/frappe-gantt/dist/frappe-gantt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script>
const LS_KEY="era_tasks_v1";
function load(){ try{const r=localStorage.getItem(LS_KEY);return r?JSON.parse(r):seed();}catch(e){return seed();} }
function save(data){ localStorage.setItem(LS_KEY, JSON.stringify(data)); }
function seed(){
  return [
    { id: 1, name: "基礎工事", assignee: "佐藤", workType:"基礎", start: "2025-08-01", end: "2025-08-10", progress: 40, status: "ToDo", tags: ["工程A","重要"], notes: "地盤調査完了後に開始" },
    { id: 2, name: "足場組立", assignee: "田中", workType:"外構", start: "2025-08-05", end: "2025-08-15", progress: 60, status: "進行中", tags: ["安全","外構"], notes: "足場資材の在庫確認済み" },
    { id: 3, name: "配管工事", assignee: "佐藤", workType:"配管", start: "2025-08-10", end: "2025-08-20", progress: 20, status: "完了", tags: ["水道","住宅"], notes: "施工図面を確認" }
  ];
}
let tasks=load();
const filter={assignee:"",workType:"",from:"",to:""};
function toISO(d){return new Date(d).toISOString().slice(0,10);}
function addOneDay(iso){const d=new Date(iso);d.setDate(d.getDate()+1);return toISO(d);}
function getTask(id){return tasks.find(t=>t.id===id);}
function applyFilter(list){
  const f=filter;
  return list.filter(t=>{
    if(f.assignee && t.assignee!==f.assignee) return false;
    if(f.workType && t.workType!==f.workType) return false;
    if(f.from && new Date(t.start)<new Date(f.from)) return false;
    if(f.to && new Date(t.end)>new Date(f.to)) return false;
    return true;
  });
}
function uniqueValues(key){return Array.from(new Set(tasks.map(t=>(t[key]||"").trim()).filter(Boolean)));}

function renderFilterOptions(){
  const sa=document.getElementById("filterAssignee");
  const sw=document.getElementById("filterWorkType");
  const ass=uniqueValues("assignee"), works=uniqueValues("workType");
  sa.innerHTML='<option value="">担当者：全て</option>'+ass.map(v=>`<option value="${v}">${v}</option>`).join("");
  sw.innerHTML='<option value="">工事内容：全て</option>'+works.map(v=>`<option value="${v}">${v}</option>`).join("");
}
document.getElementById("btnApplyFilter").addEventListener("click",()=>{
  filter.assignee=document.getElementById("filterAssignee").value;
  filter.workType=document.getElementById("filterWorkType").value;
  filter.from=document.getElementById("filterFrom").value;
  filter.to=document.getElementById("filterTo").value;
  renderAll();
});
document.getElementById("btnResetFilter").addEventListener("click",()=>{
  filter.assignee="";filter.workType="";filter.from="";filter.to="";
  document.getElementById("filterAssignee").value="";
  document.getElementById("filterWorkType").value="";
  document.getElementById("filterFrom").value="";
  document.getElementById("filterTo").value="";
  renderAll();
});

function renderAll(){
  const list=applyFilter(tasks);
  renderKanban(list); renderGantt(list); renderCalendar(list); renderTable(list);
  save(tasks); renderFilterOptions();
}

// Kanban
function renderKanban(list){
  const cols={"ToDo":document.getElementById("kanban-todo"),"進行中":document.getElementById("kanban-doing"),"完了":document.getElementById("kanban-done")};
  Object.values(cols).forEach(el=>el.innerHTML="");
  list.forEach(t=>{
    const card=document.createElement("div");
    card.className="kanban-card"; card.setAttribute("draggable","true");
    card.addEventListener("dragstart",(e)=>onDragStart(e,t.id));
    const tagHtml=(t.tags||[]).map(tag=>`<span class="badge rounded-pill badge-tag me-1">${tag}</span>`).join("");
    card.innerHTML=`
      <div class="d-flex justify-content-between align-items-start">
        <div style="min-width:0;">
          <div class="fw-bold text-truncate" title="${t.name}">${t.name}</div>
          <div class="small text-muted">${t.assignee}｜${t.workType||"-"}｜${t.start} → ${t.end}</div>
          <div class="mt-1">${tagHtml}</div>
          <div class="progress-label mt-1">${t.progress}%</div>
          <div class="progress-track"><div class="progress-fill" style="width:${t.progress}%"></div></div>
        </div>
        <div class="ms-2 flex-shrink-0">
          <button class="btn btn-sm btn-outline-primary mb-1" onclick="event.stopPropagation(); editTask(${t.id});">編集</button>
          <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); delTask(${t.id});">削除</button>
        </div>
      </div>`;
    card.addEventListener("click",()=>openDetail(t.id));
    const track=card.querySelector(".progress-track"); let dragging=false;
    const update=(ev)=>{
      const r=track.getBoundingClientRect(); const ratio=Math.max(0,Math.min(1,(ev.clientX-r.left)/r.width));
      const pct=Math.round(ratio*100); const i=tasks.findIndex(x=>x.id===t.id); if(i>=0) tasks[i].progress=pct;
      track.querySelector(".progress-fill").style.width=pct+"%"; track.previousElementSibling.textContent=pct+"%";
    };
    track.addEventListener("mousedown",(e)=>{e.stopPropagation();dragging=true;update(e);});
    window.addEventListener("mousemove",(e)=>{if(dragging)update(e);});
    window.addEventListener("mouseup",()=>{ if(dragging){dragging=false; save(tasks); renderGantt(applyFilter(tasks));} });
    cols[t.status]?.appendChild(card);
  });
}
function onDragStart(ev,id){ev.dataTransfer.setData("text/plain",String(id));}
function allowDrop(ev){ev.preventDefault();}
function onDrop(ev){
  ev.preventDefault();
  const id=parseInt(ev.dataTransfer.getData("text/plain"),10);
  const status=ev.currentTarget.getAttribute("data-status");
  const i=tasks.findIndex(t=>t.id===id);
  if(i>=0){ tasks[i].status=status; save(tasks); renderAll(); }
}

// Gantt
let ganttInstance=null;
function renderGantt(list){
  const data=list.map(t=>({id:t.id,name:t.name,start:t.start,end:t.end,progress:t.progress}));
  const tgt=document.getElementById("gantt"); tgt.innerHTML="";
  ganttInstance=new Gantt("#gantt",data,{
    on_click:(task)=>openDetail(task.id),
    on_date_change:(task,start,end)=>{
      const i=tasks.findIndex(x=>x.id===task.id);
      if(i>=0){ tasks[i].start=toISO(start); tasks[i].end=toISO(end); save(tasks); renderAll(); }
    },
    on_progress_change:(task,progress)=>{
      const i=tasks.findIndex(x=>x.id===task.id);
      if(i>=0){ tasks[i].progress=Math.round(progress); save(tasks); renderKanban(applyFilter(tasks)); }
    }
  });
}

// Calendar
let calendar;
function renderCalendar(list){
  const el=document.getElementById("calendar"); if(calendar){calendar.destroy();}
  const events=list.map(t=>({id:String(t.id), title:t.name, start:t.start, end:addOneDay(t.end), editable:true}));
  calendar=new FullCalendar.Calendar(el,{
    initialView:"dayGridMonth", events, editable:true,
    eventDrop:(info)=>{
      const id=parseInt(info.event.id,10); const i=tasks.findIndex(t=>t.id===id);
      if(i>=0){
        const start=toISO(info.event.start); const endISO=toISO(info.event.end??info.event.start);
        const realEnd=toISO(new Date(new Date(endISO).getTime()-24*60*60*1000));
        tasks[i].start=start; tasks[i].end=realEnd; save(tasks); renderAll();
      }
    },
    eventResize:(info)=>{
      const id=parseInt(info.event.id,10); const i=tasks.findIndex(t=>t.id===id);
      if(i>=0){
        const endISO=toISO(info.event.end);
        const realEnd=toISO(new Date(new Date(endISO).getTime()-24*60*60*1000));
        tasks[i].end=realEnd; save(tasks); renderAll();
      }
    },
    eventClick:(info)=>openDetail(parseInt(info.event.id,10))
  });
  calendar.render();
}

// Table
function renderTable(list){
  const tbody=document.getElementById("tableBody"); tbody.innerHTML="";
  list.forEach(t=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><a href="#" onclick="openDetail(${t.id});return false;">${t.name}</a></td>
      <td>${t.assignee}</td><td>${t.workType||"-"}</td>
      <td>${t.start}</td><td>${t.end}</td><td>${t.progress}%</td><td>${t.status}</td>
      <td>${(t.tags||[]).map(tag=>`<span class="badge rounded-pill badge-tag me-1">${tag}</span>`).join("")}</td>
      <td class="text-nowrap">
        <button class="btn btn-sm btn-outline-primary me-1" onclick="editTask(${t.id})">編集</button>
        <button class="btn btn-sm btn-outline-danger" onclick="delTask(${t.id})">削除</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

// Modal
const taskModal=new bootstrap.Modal(document.getElementById('taskModal'));
let modalTaskId=null;
function openDetail(id){
  const t=getTask(id); if(!t)return; modalTaskId=id;
  document.getElementById("taskModalTitle").textContent=t.name;
  document.getElementById("taskModalBody").innerHTML=`
    <div class="row g-2">
      <div class="col-md-6"><span class="text-muted">担当者：</span>${t.assignee}</div>
      <div class="col-md-6"><span class="text-muted">工事内容：</span>${t.workType||"-"}</div>
      <div class="col-md-6"><span class="text-muted">開始日：</span>${t.start}</div>
      <div class="col-md-6"><span class="text-muted">期限：</span>${t.end}</div>
      <div class="col-md-6"><span class="text-muted">ステータス：</span>${t.status}</div>
      <div class="col-md-6"><span class="text-muted">進捗：</span>${t.progress}%</div>
      <div class="col-12"><span class="text-muted">タグ：</span>${(t.tags||[]).map(x=>`<span class='badge rounded-pill badge-tag me-1'>${x}</span>`).join("")||"-"}</div>
      <div class="col-12"><span class="text-muted">備考：</span><div class="border rounded p-2 bg-light">${(t.notes||"").replace(/\n/g,"<br>")}</div></div>
    </div>`;
  taskModal.show();
}
document.getElementById("btnModalEdit").addEventListener("click",()=>{ if(modalTaskId==null)return; editTask(modalTaskId); taskModal.hide(); });
document.getElementById("btnModalDelete").addEventListener("click",()=>{ if(modalTaskId==null)return; delTask(modalTaskId); taskModal.hide(); });

function editTask(id){
  const t=getTask(id); if(!t)return;
  sessionStorage.setItem("era_edit_task", JSON.stringify(t));
  window.location.href="/admin/task-create";
}
function delTask(id){
  if(!confirm("削除しますか？")) return;
  tasks=tasks.filter(t=>t.id!==id); save(tasks); renderAll();
}

document.getElementById('viewTabs').addEventListener('shown.bs.tab',(e)=>{
  const t=e.target.getAttribute('data-bs-target'); const list=applyFilter(tasks);
  if(t==='#tab-timeline') renderGantt(list);
  if(t==='#tab-calendar') renderCalendar(list);
  if(t==='#tab-table') renderTable(list);
  if(t==='#tab-kanban') renderKanban(list);
});

renderAll();
</script>

</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://unpkg.com/frappe-gantt/dist/frappe-gantt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

</body></html>